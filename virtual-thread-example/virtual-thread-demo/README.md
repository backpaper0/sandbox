# Spring Boot（Spring Web MVC）で仮想スレッドを試す

- [Spring Boot Reference Documentation > Core Features > 1.14. Virtual threads](https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.spring-application.virtual-threads)

<details>
<summary>クエリー実行しているところのコールスタック</summary>

```
#68 "tomcat-handler-1" virtual
      java.base/java.lang.VirtualThread.park(VirtualThread.java:582)
      java.base/java.lang.System$2.parkVirtualThread(System.java:2639)
      java.base/jdk.internal.misc.VirtualThreads.park(VirtualThreads.java:54)
      java.base/java.util.concurrent.locks.LockSupport.park(LockSupport.java:369)
      java.base/sun.nio.ch.Poller.pollIndirect(Poller.java:139)
      java.base/sun.nio.ch.Poller.poll(Poller.java:102)
      java.base/sun.nio.ch.Poller.poll(Poller.java:87)
      java.base/sun.nio.ch.NioSocketImpl.park(NioSocketImpl.java:175)
      java.base/sun.nio.ch.NioSocketImpl.park(NioSocketImpl.java:201)
      java.base/sun.nio.ch.NioSocketImpl.implRead(NioSocketImpl.java:309)
      java.base/sun.nio.ch.NioSocketImpl.read(NioSocketImpl.java:346)
      java.base/sun.nio.ch.NioSocketImpl$1.read(NioSocketImpl.java:796)
      java.base/java.net.Socket$SocketInputStream.read(Socket.java:1099)
      org.postgresql.core.VisibleBufferedInputStream.readMore(VisibleBufferedInputStream.java:161)
      org.postgresql.core.VisibleBufferedInputStream.ensureBytes(VisibleBufferedInputStream.java:128)
      org.postgresql.core.VisibleBufferedInputStream.ensureBytes(VisibleBufferedInputStream.java:113)
      org.postgresql.core.VisibleBufferedInputStream.read(VisibleBufferedInputStream.java:73)
      org.postgresql.core.PGStream.receiveChar(PGStream.java:465)
      org.postgresql.core.v3.QueryExecutorImpl.processResults(QueryExecutorImpl.java:2155)
      org.postgresql.core.v3.QueryExecutorImpl.execute(QueryExecutorImpl.java:368)
      org.postgresql.jdbc.PgStatement.executeInternal(PgStatement.java:498)
      org.postgresql.jdbc.PgStatement.execute(PgStatement.java:415)
      org.postgresql.jdbc.PgPreparedStatement.executeWithFlags(PgPreparedStatement.java:190)
      org.postgresql.jdbc.PgPreparedStatement.executeQuery(PgPreparedStatement.java:134)
      com.zaxxer.hikari.pool.ProxyPreparedStatement.executeQuery(ProxyPreparedStatement.java:52)
      com.zaxxer.hikari.pool.HikariProxyPreparedStatement.executeQuery(HikariProxyPreparedStatement.java)
      org.springframework.jdbc.core.JdbcTemplate$1.doInPreparedStatement(JdbcTemplate.java:732)
      org.springframework.jdbc.core.JdbcTemplate.execute(JdbcTemplate.java:658)
      org.springframework.jdbc.core.JdbcTemplate.query(JdbcTemplate.java:723)
      org.springframework.jdbc.core.JdbcTemplate.query(JdbcTemplate.java:748)
      org.springframework.jdbc.core.JdbcTemplate.query(JdbcTemplate.java:804)
      org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate.query(NamedParameterJdbcTemplate.java:218)
      org.springframework.jdbc.core.simple.DefaultJdbcClient$DefaultStatementSpec$NamedParamMappedQuerySpec.list(DefaultJdbcClient.java:366)
      org.springframework.jdbc.core.simple.JdbcClient$MappedQuerySpec.single(JdbcClient.java:404)
      com.example.DemoController.getMessage(DemoController.java:26)
      java.base/jdk.internal.reflect.DirectMethodHandleAccessor.invoke(DirectMethodHandleAccessor.java:103)
      java.base/java.lang.reflect.Method.invoke(Method.java:580)
      org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:351)
      org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint(ReflectiveMethodInvocation.java:196)
      org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:163)
      org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:765)
      org.springframework.transaction.interceptor.TransactionInterceptor$1.proceedWithInvocation(TransactionInterceptor.java:123)
      org.springframework.transaction.interceptor.TransactionAspectSupport.invokeWithinTransaction(TransactionAspectSupport.java:392)
      org.springframework.transaction.interceptor.TransactionInterceptor.invoke(TransactionInterceptor.java:119)
      org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)
      org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:765)
      org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:717)
      com.example.DemoController$$SpringCGLIB$$0.getMessage(<generated>)
      java.base/jdk.internal.reflect.DirectMethodHandleAccessor.invoke(DirectMethodHandleAccessor.java:103)
      java.base/java.lang.reflect.Method.invoke(Method.java:580)
      org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:255)
      org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:188)
      org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:118)
      org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:925)
      org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:830)
      org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:87)
      org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1089)
      org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:979)
      org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014)
      org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:903)
      jakarta.servlet.http.HttpServlet.service(HttpServlet.java:564)
      org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885)
      jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)
      org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:205)
      org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:149)
      org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:51)
      org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:174)
      org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:149)
      org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)
      org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
      org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:174)
      org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:149)
      org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93)
      org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
      org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:174)
      org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:149)
      org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:201)
      org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
      org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:174)
      org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:149)
      org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:167)
      org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:90)
      org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:482)
      org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:115)
      org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:93)
      org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:74)
      org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:344)
      org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:391)
      org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:63)
      org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:896)
      org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1744)
      org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:52)
      java.base/java.lang.VirtualThread.run(VirtualThread.java:309)
```

</details>

<details>
<summary>コネクションを払い出しているところのコールスタック</summary>

```
#69 "tomcat-handler-2" virtual
      java.base/java.lang.VirtualThread.parkNanos(VirtualThread.java:621)
      java.base/java.lang.System$2.parkVirtualThread(System.java:2648)
      java.base/jdk.internal.misc.VirtualThreads.park(VirtualThreads.java:67)
      java.base/java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:267)
      java.base/java.util.concurrent.SynchronousQueue$TransferQueue.transfer(SynchronousQueue.java:704)
      java.base/java.util.concurrent.SynchronousQueue.poll(SynchronousQueue.java:903)
      com.zaxxer.hikari.util.ConcurrentBag.borrow(ConcurrentBag.java:151)
      com.zaxxer.hikari.pool.HikariPool.getConnection(HikariPool.java:164)
      com.zaxxer.hikari.pool.HikariPool.getConnection(HikariPool.java:146)
      com.zaxxer.hikari.HikariDataSource.getConnection(HikariDataSource.java:128)
      org.springframework.jdbc.datasource.DataSourceTransactionManager.doBegin(DataSourceTransactionManager.java:269)
      org.springframework.transaction.support.AbstractPlatformTransactionManager.startTransaction(AbstractPlatformTransactionManager.java:531)
      org.springframework.transaction.support.AbstractPlatformTransactionManager.getTransaction(AbstractPlatformTransactionManager.java:405)
      org.springframework.transaction.interceptor.TransactionAspectSupport.createTransactionIfNecessary(TransactionAspectSupport.java:617)
      org.springframework.transaction.interceptor.TransactionAspectSupport.invokeWithinTransaction(TransactionAspectSupport.java:386)
      org.springframework.transaction.interceptor.TransactionInterceptor.invoke(TransactionInterceptor.java:119)
      org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)
      org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:765)
      org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:717)
      com.example.DemoController$$SpringCGLIB$$0.getMessage(<generated>)
      java.base/jdk.internal.reflect.DirectMethodHandleAccessor.invoke(DirectMethodHandleAccessor.java:103)
      java.base/java.lang.reflect.Method.invoke(Method.java:580)
      org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:255)
      org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:188)
      org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:118)
      org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:925)
      org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:830)
      org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:87)
      org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1089)
      org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:979)
      org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014)
      org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:903)
      jakarta.servlet.http.HttpServlet.service(HttpServlet.java:564)
      org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885)
      jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)
      org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:205)
      org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:149)
      org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:51)
      org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:174)
      org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:149)
      org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)
      org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
      org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:174)
      org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:149)
      org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93)
      org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
      org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:174)
      org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:149)
      org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:201)
      org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
      org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:174)
      org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:149)
      org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:167)
      org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:90)
      org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:482)
      org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:115)
      org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:93)
      org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:74)
      org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:344)
      org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:391)
      org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:63)
      org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:896)
      org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1744)
      org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:52)
      java.base/java.lang.VirtualThread.run(VirtualThread.java:309)
```

</details>
