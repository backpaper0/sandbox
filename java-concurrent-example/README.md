# Java並行処理による性能向上のデモ

## 概要

このプロジェクトは、Javaのプラットフォームスレッドと仮想スレッド（Virtual Threads）を使用した並行処理の性能比較を行うデモアプリケーションです。CPUバウンドな処理を例に、異なる並行処理方式による実行時間の違いを確認できます。

このデモでは、以下の実行方式を比較できます：

- **シングルスレッド実行**: 並行処理を行わない基準となる実装
- **プラットフォームスレッド実行**: 従来のOSネイティブスレッドを使用した並列処理
- **仮想スレッド実行**: Java 21の仮想スレッドを使用した並列処理

## 準備

プロジェクトをビルドするために、以下のコマンドを実行してください。

```bash
mvn compile
```

## CPUバウンドな処理の性能比較

### 1. シングルスレッド実行

並行処理を行わず、すべての処理を順次実行します。他の実行方式との性能比較の基準となります。

```bash
mvn -Pcpu exec:exec -Dexecutor=single
```

### 2. プラットフォームスレッド実行

従来のJavaスレッド（プラットフォームスレッド）を使用して並列処理を行います。デフォルトでは8スレッドで実行されます。

```bash
mvn -Pcpu exec:exec -Dexecutor=platform
```

### 3. 仮想スレッド実行

Java 21の仮想スレッドを使用して並列処理を行います。デフォルトでは8個のプラットフォームスレッドが割り当てられ、効率的に並列処理が実行されます。

```bash
mvn -Pcpu exec:exec -Dexecutor=virtual
```

### 4. 仮想スレッド実行（制限あり）

仮想スレッドに割り当てられるプラットフォームスレッド数を1に制限します。この設定では並列実行の効果が得られず、性能向上は期待できません。仮想スレッドの制約を理解するための参考実装です。

```bash
mvn -Pcpu exec:exec -Dexecutor=virtual -Dparallelism=1
```

### 期待される結果

CPUバウンドな処理の場合、以下のような性能差が観察できます：

- **シングルスレッド**: 最も処理時間がかかる
- **プラットフォームスレッド（8スレッド）**: シングルスレッドと比較して大幅に高速
- **仮想スレッド（並列度8）**: プラットフォームスレッドと同等の性能
- **仮想スレッド（並列度1）**: シングルスレッドと同等の性能

## IOバウンドな処理の性能比較

I/Oバウンドな処理では、HTTPリクエストなどのネットワークI/O待機時間が処理時間の大部分を占めます。このデモでは、3秒の遅延を伴うHTTPリクエストを複数回実行し、各実行方式の性能を比較します。

### 準備

HTTPリクエストのテストサーバーとして、httpbinコンテナを起動します。

```bash
docker run -d --name httpbin -p 8080:80 kennethreitz/httpbin
```

### 1. シングルスレッド実行

並行処理を行わず、すべてのHTTPリクエストを順次実行します。他の実行方式との性能比較の基準となります。

```bash
mvn -Pio exec:exec -Dexecutor=single
```

### 2. プラットフォームスレッド実行

従来のJavaスレッド（プラットフォームスレッド）を使用して並列処理を行います。デフォルトでは4スレッドで実行されます。

```bash
mvn -Pio exec:exec -Dexecutor=platform
```

### 3. 仮想スレッド実行

Java 21の仮想スレッドを使用して並列処理を行います。I/Oバウンドな処理では、仮想スレッドが最も効率的に動作します。

```bash
mvn -Pio exec:exec -Dexecutor=virtual
```

### 4. 仮想スレッド実行（制限あり）

仮想スレッドに割り当てられるプラットフォームスレッド数を1に制限します。I/Oバウンドな処理の場合、制限があっても複数の仮想スレッドが効率的にI/O待機を行うため、一定の並列実行効果が期待できます。

```bash
mvn -Pio exec:exec -Dexecutor=virtual -Dparallelism=1
```

### 期待される結果

I/Oバウンドな処理の場合、以下のような性能差が観察できます：

- **シングルスレッド**: タスク数 × 遅延時間（例: 4タスク × 3秒 = 約12秒）
- **プラットフォームスレッド（4スレッド）**: ほぼ遅延時間のみ（例: 約3秒）
- **仮想スレッド（並列度制限なし）**: ほぼ遅延時間のみ（例: 約3秒）
- **仮想スレッド（並列度1）**: ほぼ遅延時間のみ（例: 約3秒）※CPUバウンドと異なり、I/O待機中に他の仮想スレッドが実行できるため
